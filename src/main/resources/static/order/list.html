<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的订单</title>
    <link rel="stylesheet" href="/libs/element-ui/index.css">
    <link href="/css/custom.css" rel="stylesheet">
</head>
<body>
    <div id="app" class="container">
        <div class="page-header">
            <h2>我的订单</h2>
        </div>

        <div class="search-form">
            <el-form :inline="true" :model="queryForm" class="demo-form-inline">
                <el-form-item label="订单状态">
                    <el-select v-model="queryForm.orderStatus" placeholder="请选择订单状态" clearable style="width: 200px;">
                        <el-option label="待支付" :value="0"></el-option>
                        <el-option label="已支付" :value="1"></el-option>
                        <el-option label="已退票" :value="2"></el-option>
                        <el-option label="已改签" :value="3"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item>
                    <el-button type="primary" @click="handleQuery">查询</el-button>
                    <el-button @click="resetQuery">重置</el-button>
                </el-form-item>
            </el-form>
        </div>

        <el-table :data="orderList" border style="width: 100%;" v-loading="loading">
            <el-table-column prop="orderNo" label="订单号" align="center" width="180"></el-table-column>
            <el-table-column label="车次" align="center">
                <template slot-scope="scope">{{ scope.row.trainNo || '加载中...' }}</template>
            </el-table-column>
            <el-table-column label="出发站" align="center">
                <template slot-scope="scope">{{ scope.row.departureStationName || '' }}</template>
            </el-table-column>
            <el-table-column label="到达站" align="center">
                <template slot-scope="scope">{{ scope.row.arrivalStationName || '' }}</template>
            </el-table-column>
            <el-table-column label="出发时间" align="center">
                <template slot-scope="scope">
                    <span v-if="scope.row.departureTime">{{ formatDateTime(null, null, scope.row.departureTime) }}</span>
                    <span v-else-if="scope.row.trainId" style="color: #999;">加载中...</span>
                    <span v-else style="color: #999;">-</span>
                </template>
            </el-table-column>
            <el-table-column prop="totalAmount" label="订单金额" align="center" :formatter="formatMoney"></el-table-column>
            <el-table-column prop="orderStatus" label="订单状态" align="center" :formatter="formatOrderStatus"></el-table-column>
            <el-table-column prop="createTime" label="创建时间" align="center" :formatter="formatDateTime"></el-table-column>
            <el-table-column label="操作" align="center" width="350">
                <template slot-scope="scope">
                    <el-button type="primary" size="small" @click="viewDetail(scope.row)">查看详情</el-button>
                    <el-button v-if="scope.row.orderStatus === 0" type="success" size="small" @click="payOrder(scope.row)">支付</el-button>
                    <el-button v-if="scope.row.orderStatus === 1" type="warning" size="small" @click="refundOrder(scope.row)">退票</el-button>
                    <el-button v-if="scope.row.orderStatus === 1" type="info" size="small" @click="changeOrder(scope.row)">改签</el-button>
                    <el-button v-if="scope.row.orderStatus === 1" type="primary" size="small" @click="downloadTicket(scope.row)">下载电子票</el-button>
                </template>
            </el-table-column>
        </el-table>

        <el-pagination
            @size-change="handleSizeChange"
            @current-change="handleCurrentChange"
            :current-page="pagination.current"
            :page-sizes="[10, 20, 50, 100]"
            :page-size="pagination.size"
            layout="total, sizes, prev, pager, next, jumper"
            :total="pagination.total"
            style="margin-top: 20px; text-align: right;">
        </el-pagination>

        <!-- 订单详情对话框 -->
        <el-dialog title="订单详情" :visible.sync="detailDialogVisible" width="800px">
            <el-table :data="[currentOrder]" border style="width: 100%;">
                <el-table-column prop="orderNo" label="订单号" align="center"></el-table-column>
                <el-table-column prop="trainNo" label="车次" align="center"></el-table-column>
                <el-table-column prop="departureStationName" label="出发站" align="center"></el-table-column>
                <el-table-column prop="arrivalStationName" label="到达站" align="center"></el-table-column>
                <el-table-column prop="departureTime" label="出发时间" align="center" :formatter="formatDateTime"></el-table-column>
                <el-table-column prop="arrivalTime" label="到达时间" align="center" :formatter="formatDateTime"></el-table-column>
                <el-table-column prop="totalAmount" label="订单金额" align="center" :formatter="formatMoney"></el-table-column>
                <el-table-column prop="orderStatus" label="订单状态" align="center" :formatter="formatOrderStatus"></el-table-column>
            </el-table>
            <h3 style="margin-top: 20px;">乘车人信息</h3>
            <el-table :data="orderDetailList" border>
                <el-table-column prop="passengerName" label="姓名" align="center"></el-table-column>
                <el-table-column prop="idCard" label="身份证号" align="center"></el-table-column>
                <el-table-column label="座位类型" align="center">
                    <template slot-scope="scope">{{ scope.row.seatTypeName || '加载中...' }}</template>
                </el-table-column>
                <el-table-column label="票价" align="center">
                    <template slot-scope="scope">￥{{ formatMoney(scope.row.price) }}</template>
                </el-table-column>
            </el-table>
        </el-dialog>

        <!-- 支付对话框 -->
        <el-dialog title="支付订单" :visible.sync="payDialogVisible" width="400px">
            <el-form :model="payForm">
                <el-form-item label="支付方式">
                    <el-select v-model="payForm.payType" placeholder="请选择支付方式" style="width: 100%;">
                        <el-option label="银联" value="银联"></el-option>
                        <el-option label="微信" value="微信"></el-option>
                        <el-option label="支付宝" value="支付宝"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="订单金额">
                    <span style="color: #f56c6c; font-size: 20px;">￥{{ formatMoney(currentOrder.totalAmount) }}</span>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button @click="payDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="confirmPay">确认支付</el-button>
            </div>
        </el-dialog>

        <!-- 改签对话框 -->
        <el-dialog title="改签订单" :visible.sync="changeDialogVisible" width="600px">
            <el-form :model="changeForm">
                <el-form-item label="新车次">
                    <el-select v-model="changeForm.newTrainId" placeholder="请选择新车次" filterable style="width: 100%;">
                        <el-option v-for="train in trainList" :key="train.id" 
                            :label="train.trainNo + ' ' + (train.departureStationName || '') + ' -> ' + (train.arrivalStationName || '') + ' ' + formatDateTime(null, null, train.departureTime)" 
                            :value="train.id">
                        </el-option>
                    </el-select>
                    <div v-if="trainList.length === 0" style="color: #999; margin-top: 10px; font-size: 12px;">
                        暂无可选车次
                    </div>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button @click="changeDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="confirmChange">确认改签</el-button>
            </div>
        </el-dialog>
    </div>

    <script src="/libs/vue/vue.js"></script>
    <script src="/libs/element-ui/index.js"></script>
    <script src="/libs/axios/axios.min.js"></script>
    <script src="/js/common.js"></script>
    <script>
        // 检查登录状态
        const userStr = sessionStorage.getItem('user');
        if (!userStr) {
            window.location.href = '/static/login/login.html';
        }

        const userInfo = JSON.parse(userStr || '{}');
        console.log('用户信息:', userInfo);
        new Vue({
            el: '#app',
            data() {
                return {
                    userId: userInfo.id,
                    loading: false,
                    queryForm: {
                        orderStatus: null
                    },
                    orderList: [],
                    orderDetailList: [],
                    trainList: [],
                    currentOrder: {},
                    detailDialogVisible: false,
                    payDialogVisible: false,
                    changeDialogVisible: false,
                    payForm: {
                        payType: ''
                    },
                    changeForm: {
                        newTrainId: null
                    },
                    pagination: {
                        current: 1,
                        size: 10,
                        total: 0
                    }
                }
            },
            mounted() {
                console.log('订单列表页面加载，用户ID:', this.userId);
                this.handleQuery();
            },
            methods: {
                handleQuery() {
                    if (!this.userId) {
                        this.$message.error('用户信息错误，请重新登录');
                        setTimeout(() => {
                            window.location.href = '/static/login/login.html';
                        }, 1000);
                        return;
                    }
                    this.loading = true;
                    const order = {
                        userId: this.userId,
                        orderStatus: this.queryForm.orderStatus
                    };
                    console.log('查询订单参数:', order, '分页:', this.pagination);
                    axios.post('/api/order/query_page?current=' + this.pagination.current + '&size=' + this.pagination.size, order)
                        .then(response => {
                            this.loading = false;
                            console.log('订单查询响应:', response.data);
                            if (response.data.code === 200) {
                                const pageResult = response.data.data;
                                this.orderList = pageResult.records || [];
                                this.pagination.total = pageResult.total || 0;
                                console.log('订单列表:', this.orderList, '总数:', this.pagination.total);
                                // 强制更新视图
                                this.$nextTick(() => {
                                    this.$forceUpdate();
                                });
                                if (this.orderList.length > 0) {
                                    this.loadTrainInfo();
                                } else {
                                    this.$message.info('暂无订单数据');
                                }
                            } else {
                                this.$message.error(response.data.message || '查询订单失败');
                            }
                        })
                        .catch(error => {
                            this.loading = false;
                            console.error('订单查询错误:', error);
                            this.$message.error('查询订单失败：' + (error.response?.data?.message || error.message));
                        });
                },
                loadTrainInfo() {
                    // 加载车次信息
                    const trainIds = [...new Set(this.orderList.map(o => o.trainId).filter(id => id))];
                    if (trainIds.length === 0) {
                        return;
                    }
                    let loadedCount = 0;
                    trainIds.forEach(trainId => {
                        axios.get('/api/train/select_by_id?id=' + trainId)
                            .then(response => {
                                if (response.data.code === 200 && response.data.data) {
                                    const train = response.data.data;
                                    console.log('加载车次信息:', train.trainNo, '出发时间:', train.departureTime);
                                    this.orderList.forEach((order, index) => {
                                        if (order.trainId === train.id) {
                                            this.$set(this.orderList[index], 'trainNo', train.trainNo);
                                            this.$set(this.orderList[index], 'departureTime', train.departureTime);
                                            this.$set(this.orderList[index], 'arrivalTime', train.arrivalTime);
                                            console.log('设置订单出发时间:', index, train.departureTime);
                                        }
                                    });
                                }
                                loadedCount++;
                                if (loadedCount === trainIds.length) {
                                    this.$nextTick(() => {
                                        this.$forceUpdate();
                                        this.loadStationNames();
                                    });
                                }
                            })
                            .catch(error => {
                                console.error('加载车次信息失败', error);
                                loadedCount++;
                                if (loadedCount === trainIds.length) {
                                    this.$nextTick(() => {
                                        this.$forceUpdate();
                                        this.loadStationNames();
                                    });
                                }
                            });
                    });
                },
                loadStationNames() {
                    axios.get('/api/station/list_all')
                        .then(response => {
                            if (response.data.code === 200) {
                                const stations = response.data.data || [];
                                const trainIds = [...new Set(this.orderList.map(o => o.trainId).filter(id => id))];
                                let loadedCount = 0;
                                
                                trainIds.forEach(trainId => {
                                    axios.get('/api/train/select_by_id?id=' + trainId)
                                        .then(response => {
                                            if (response.data.code === 200 && response.data.data) {
                                                const train = response.data.data;
                                                const departureStation = stations.find(s => s.id === train.departureStationId);
                                                const arrivalStation = stations.find(s => s.id === train.arrivalStationId);
                                                
                                                this.orderList.forEach((order, index) => {
                                                    if (order.trainId === train.id) {
                                                        this.$set(this.orderList[index], 'departureStationName', departureStation ? departureStation.stationName : '');
                                                        this.$set(this.orderList[index], 'arrivalStationName', arrivalStation ? arrivalStation.stationName : '');
                                                    }
                                                });
                                            }
                                            loadedCount++;
                                            if (loadedCount === trainIds.length) {
                                                this.$nextTick(() => {
                                                    this.$forceUpdate();
                                                });
                                            }
                                        })
                                        .catch(error => {
                                            console.error('加载车站名称失败', error);
                                            loadedCount++;
                                            if (loadedCount === trainIds.length) {
                                                this.$nextTick(() => {
                                                    this.$forceUpdate();
                                                });
                                            }
                                        });
                                });
                                
                                if (trainIds.length === 0) {
                                    this.$nextTick(() => {
                                        this.$forceUpdate();
                                    });
                                }
                            }
                        })
                        .catch(error => {
                            console.error('加载车站列表失败', error);
                        });
                },
                resetQuery() {
                    this.queryForm.orderStatus = null;
                    this.handleQuery();
                },
                viewDetail(row) {
                    this.currentOrder = Object.assign({}, row);
                    axios.get('/api/order_detail/get_by_order_id?orderId=' + row.id)
                        .then(response => {
                            if (response.data.code === 200) {
                                this.orderDetailList = response.data.data || [];
                                this.loadSeatTypeNames();
                            } else {
                                this.$message.error('加载订单详情失败');
                            }
                        })
                        .catch(error => {
                            console.error('加载订单详情失败', error);
                            this.$message.error('加载订单详情失败');
                        });
                    this.detailDialogVisible = true;
                },
                loadSeatTypeNames() {
                    if (this.orderDetailList.length === 0) {
                        return;
                    }
                    axios.get('/api/seat_type/list_all')
                        .then(response => {
                            if (response.data.code === 200) {
                                const seatTypes = response.data.data || [];
                                this.orderDetailList.forEach((detail, index) => {
                                    const seatType = seatTypes.find(st => st.id === detail.seatTypeId);
                                    this.$set(this.orderDetailList[index], 'seatTypeName', seatType ? seatType.typeName : '未知类型');
                                });
                                this.$nextTick(() => {
                                    this.$forceUpdate();
                                });
                            }
                        })
                        .catch(error => {
                            console.error('加载座位类型失败', error);
                            this.orderDetailList.forEach((detail, index) => {
                                this.$set(this.orderDetailList[index], 'seatTypeName', '未知类型');
                            });
                            this.$nextTick(() => {
                                this.$forceUpdate();
                            });
                        });
                },
                payOrder(row) {
                    this.currentOrder = row;
                    this.payForm.payType = '';
                    this.payDialogVisible = true;
                },
                confirmPay() {
                    if (!this.payForm.payType) {
                        this.$message.warning('请选择支付方式');
                        return;
                    }
                    axios.post('/api/order/pay', {
                        orderId: this.currentOrder.id,
                        payType: this.payForm.payType
                    })
                        .then(response => {
                            if (response.data.code === 200) {
                                this.$message.success('支付成功');
                                this.payDialogVisible = false;
                                this.handleQuery();
                            } else {
                                this.$message.error(response.data.message);
                            }
                        });
                },
                refundOrder(row) {
                    this.$confirm('确认退票吗？', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        axios.post('/api/order/refund?orderId=' + row.id)
                            .then(response => {
                                if (response.data.code === 200) {
                                    this.$message.success('退票成功');
                                    this.handleQuery();
                                } else {
                                    this.$message.error(response.data.message);
                                }
                            });
                    });
                },
                changeOrder(row) {
                    console.log('改签按钮点击，订单数据:', row);
                    this.currentOrder = row;
                    this.trainList = [];
                    this.changeForm.newTrainId = null;
                    
                    // 加载可选车次
                    axios.get('/api/train/select_by_id?id=' + row.trainId)
                        .then(response => {
                            if (response.data.code === 200 && response.data.data) {
                                const currentTrain = response.data.data;
                                console.log('当前车次信息:', currentTrain);
                                
                                // 查询相同出发站和到达站的其他车次
                                const queryData = {
                                    departureStationId: currentTrain.departureStationId,
                                    arrivalStationId: currentTrain.arrivalStationId,
                                    status: 1
                                };
                                console.log('查询改签车次条件:', queryData);
                                
                                axios.post('/api/train/query_page?current=1&size=100', queryData)
                                    .then(response => {
                                        if (response.data.code === 200) {
                                            const allTrains = response.data.data.records || [];
                                            // 过滤掉当前车次
                                            this.trainList = allTrains.filter(t => t.id !== row.trainId);
                                            console.log('可选车次列表:', this.trainList);
                                            
                                            if (this.trainList.length === 0) {
                                                this.$message.warning('没有可改签的车次，请选择其他路线');
                                            } else {
                                                this.loadChangeTrainStationNames();
                                            }
                                        } else {
                                            this.$message.error('查询车次失败：' + (response.data.message || ''));
                                        }
                                    })
                                    .catch(error => {
                                        console.error('查询车次失败', error);
                                        this.$message.error('查询车次失败：' + (error.response?.data?.message || error.message));
                                    });
                            } else {
                                this.$message.error('获取当前车次信息失败');
                            }
                        })
                        .catch(error => {
                            console.error('获取当前车次信息失败', error);
                            this.$message.error('获取当前车次信息失败：' + (error.response?.data?.message || error.message));
                        });
                    
                    this.changeDialogVisible = true;
                },
                loadChangeTrainStationNames() {
                    if (this.trainList.length === 0) {
                        return;
                    }
                    axios.get('/api/station/list_all')
                        .then(response => {
                            if (response.data.code === 200) {
                                const stations = response.data.data || [];
                                this.trainList.forEach((train, index) => {
                                    const departureStation = stations.find(s => s.id === train.departureStationId);
                                    const arrivalStation = stations.find(s => s.id === train.arrivalStationId);
                                    this.$set(this.trainList[index], 'departureStationName', departureStation ? departureStation.stationName : '');
                                    this.$set(this.trainList[index], 'arrivalStationName', arrivalStation ? arrivalStation.stationName : '');
                                });
                                this.$nextTick(() => {
                                    this.$forceUpdate();
                                });
                            }
                        })
                        .catch(error => {
                            console.error('加载车站名称失败', error);
                        });
                },
                confirmChange() {
                    if (!this.changeForm.newTrainId) {
                        this.$message.warning('请选择新车次');
                        return;
                    }
                    axios.post('/api/order/change', {
                        orderId: this.currentOrder.id,
                        newTrainId: this.changeForm.newTrainId
                    })
                        .then(response => {
                            if (response.data.code === 200) {
                                this.$message.success('改签成功');
                                this.changeDialogVisible = false;
                                this.handleQuery();
                            } else {
                                this.$message.error(response.data.message);
                            }
                        });
                },
                downloadTicket(row) {
                    axios.get('/api/order/download_ticket?orderId=' + row.id)
                        .then(response => {
                            if (response.data.code === 200) {
                                const ticketData = JSON.stringify(response.data.data);
                                sessionStorage.setItem('ticketData', ticketData);
                                window.open('/static/order/ticket.html', '_blank');
                            } else {
                                this.$message.error(response.data.message);
                            }
                        });
                },
                formatDateTime(row, column, cellValue) {
                    if (!cellValue) return '';
                    // 如果是对象，尝试从 row 中获取
                    if (typeof cellValue === 'object') {
                        return '';
                    }
                    // 处理日期时间字符串
                    let dateStr = String(cellValue);
                    // 替换 T 为空格
                    dateStr = dateStr.replace('T', ' ');
                    // 如果包含 . 则截取到秒
                    if (dateStr.indexOf('.') > 0) {
                        dateStr = dateStr.substring(0, dateStr.indexOf('.'));
                    }
                    return dateStr;
                },
                formatMoney(row, column, cellValue) {
                    return formatMoney(cellValue);
                },
                formatOrderStatus(row, column, cellValue) {
                    return orderStatusMap[cellValue] || '';
                },
                handleSizeChange(val) {
                    this.pagination.size = val;
                    this.pagination.current = 1;
                    this.handleQuery();
                },
                handleCurrentChange(val) {
                    this.pagination.current = val;
                    this.handleQuery();
                }
            }
        });
    </script>
</body>
</html>

